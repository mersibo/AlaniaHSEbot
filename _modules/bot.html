<!DOCTYPE html>
<html class="no-js" lang="ru">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    
        <title>bot &mdash; документация AlaniaHSE bot </title>
    
    <link rel="stylesheet" type="text/css" href="../_static/dist/fontawesome.css" />
      <link rel="stylesheet" type="text/css" href="../_static/dist/theme.css?v=ea6a6c20" />
            <link rel="index" title="Алфавитный указатель" href="../genindex.html" />
            <link rel="search" title="Поиск" href="../search.html" />
            <link rel="top" title="документация AlaniaHSE bot " href="#" />
            <link rel="up" title="Код модуля" href="index.html" />
    </head>
<body>
    <script type="text/javascript" src="../_static/dist/blocking.js"></script>
    <header class="container-fluid bg-primary">
        <a class="btn btn-sm btn-light skip-to-content-link" href="#main">Skip to content</a>
        <div class="container-fluid">
            <div class="navbar navbar-expand-lg navbar-dark font-weight-bold">
                    <a href="../index.html"
                        title="Wagtail"
                        class="logo navbar-brand"
                    >
                        <img src="../_static/img/wagtail-logo-new.svg" width="45" height="59" alt="Wagtail"
                            class="logo-img"
                        />
                        Sphinx Wagtail Theme
                    </a>
                
                
                <button class="navbar-toggler btn btn-primary d-lg-none" type="button" data-toggle="collapse" data-target="#collapseSidebar" aria-expanded="false" aria-controls="collapseExample">
                    <span class="navbar-toggler-icon"></span>
                    <span class="sr-only">menu</span>
                </button>
            </div>
        </div>
    </header>
    <div class="container-fluid">
        <div class="row">
            <aside class="col-12 col-lg-3 sidebar-container">
                <div id="collapseSidebar" class="collapse sticky-top d-lg-block pt-5 pr-lg-4">
<div id="searchbox" class="searchbox mb-6 px-1" role="search">
    <form id="search-form" action="../search.html" autocomplete="off" method="get" role="search">
        <div class="input-group">
            <div class="input-group-prepend">
                <div class="input-group-text border-right-0 bg-white py-3 pl-3 pr-2"><span class="fas fa-search"></span></div>
            </div>
            <input class="form-control py-3 pr-3 pl-1 h-100 border-left-0" type="search" name="q" placeholder="Search documentation" aria-label="Search documentation" id="searchinput" />
        </div>
        <input type="hidden" name="check_keywords" value="yes" />
        <input type="hidden" name="area" value="default" />
    </form>
</div><div class="site-toc">
    <nav class="toc mt-3" aria-label="Main menu">
        <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../bot.html">Bot</a></li>
</ul>

    </nav>
    <template data-toggle-item-template>
        <button class="btn btn-sm btn-link toctree-expand" type="button">
            <span class="sr-only">Toggle menu contents</span>
        </button>
    </template>
</div>
                    <div class="d-lg-none border-bottom">
                        
                    </div>
                </div>
            </aside>
            <div class="col-12 col-lg-9 pt-5">
                <header class="row align-items-baseline">
                    <div class="col">
                        <nav aria-label="breadcrumb">
    <ol class="breadcrumb m-0 p-0 bg-transparent">
        <li class="breadcrumb-item"><a href="../index.html">Docs</a></li>
            <li class="breadcrumb-item"><a href="index.html">Код модуля</a></li>
        <li class="breadcrumb-item active" aria-current="page">bot</li>
    </ol>
</nav>
                    </div>
                    <div class="col-sm-12 col-lg-auto mt-3 mt-lg-3">
                        <noscript>
                            <p>JavaScript is required to toggle light/dark mode..</p>
                        </noscript>
                        <button id="wagtail-theme" class="btn btn-sm btn-light text-decoration-none" type="button">
                            <span class="dark-only"><i class="fas fa-sun"></i> Light mode</span>
                            <span class="light-only"><i class="fas fa-moon"></i> Dark mode</span>
                        </button>
    <a class="btn btn-sm btn-light text-decoration-none" href="https://github.com/wagtail/sphinx_wagtail_theme/blob/main/docs/_modules/bot" rel="nofollow">
        <span class="btn-icon"><span class="fab fa-github"></span></span>
        <span class="btn-text">Edit on GitHub</span>
    </a>
                        
                    </div>
                </header>
                <div class="row" >
                    <div class="col-12">
                        <hr class="w-100 my-4">
                    </div>
                </div>
                <div class="row">
                    <div class="col-12 col-lg-9 order-last order-lg-first rst-content">
                        <main role="main" id="main">
    <h1>Исходный код bot</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">aiogram</span> <span class="kn">import</span> <span class="n">Bot</span><span class="p">,</span> <span class="n">Dispatcher</span><span class="p">,</span> <span class="n">types</span>
<span class="kn">from</span> <span class="nn">aiogram.types</span> <span class="kn">import</span> <span class="n">Message</span><span class="p">,</span> <span class="n">InlineKeyboardMarkup</span><span class="p">,</span> <span class="n">InlineKeyboardButton</span><span class="p">,</span> <span class="n">CallbackQuery</span><span class="p">,</span> <span class="n">FSInputFile</span><span class="p">,</span> <span class="n">WebAppInfo</span><span class="p">,</span> <span class="n">ChatMember</span>
<span class="kn">from</span> <span class="nn">aiogram.filters</span> <span class="kn">import</span> <span class="n">Command</span>
<span class="kn">from</span> <span class="nn">aiogram.fsm.context</span> <span class="kn">import</span> <span class="n">FSMContext</span>
<span class="kn">from</span> <span class="nn">aiogram.fsm.state</span> <span class="kn">import</span> <span class="n">StatesGroup</span><span class="p">,</span> <span class="n">State</span>
<span class="kn">from</span> <span class="nn">aiogram.utils.keyboard</span> <span class="kn">import</span> <span class="n">InlineKeyboardBuilder</span>
<span class="kn">from</span> <span class="nn">aiogram.enums</span> <span class="kn">import</span> <span class="n">ChatType</span>
<span class="kn">from</span> <span class="nn">aiogram.fsm.storage.memory</span> <span class="kn">import</span> <span class="n">MemoryStorage</span>
<span class="kn">from</span> <span class="nn">aiogram</span> <span class="kn">import</span> <span class="n">F</span>
<span class="kn">from</span> <span class="nn">aiogram.methods</span> <span class="kn">import</span> <span class="n">DeleteWebhook</span>
<span class="kn">from</span> <span class="nn">pyrogram</span> <span class="kn">import</span> <span class="n">Client</span><span class="p">,</span> <span class="n">filters</span>
<span class="kn">from</span> <span class="nn">apscheduler.schedulers.asyncio</span> <span class="kn">import</span> <span class="n">AsyncIOScheduler</span>
<span class="kn">from</span> <span class="nn">apscheduler.triggers.cron</span> <span class="kn">import</span> <span class="n">CronTrigger</span>
<span class="kn">from</span> <span class="nn">openpyxl</span> <span class="kn">import</span> <span class="n">load_workbook</span>
<span class="kn">from</span> <span class="nn">openpyxl.styles</span> <span class="kn">import</span> <span class="n">Font</span><span class="p">,</span> <span class="n">Alignment</span><span class="p">,</span> <span class="n">PatternFill</span>
<span class="kn">from</span> <span class="nn">openpyxl.utils</span> <span class="kn">import</span> <span class="n">get_column_letter</span>
<span class="kn">import</span> <span class="nn">asyncio</span>
<span class="kn">import</span> <span class="nn">pymorphy3</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">sqlite3</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">pytz</span>
<span class="kn">import</span> <span class="nn">logging</span>

<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
<span class="n">morph</span> <span class="o">=</span> <span class="n">pymorphy3</span><span class="o">.</span><span class="n">MorphAnalyzer</span><span class="p">()</span>

<span class="n">API_TOKEN</span> <span class="o">=</span> <span class="s1">&#39;7112769984:AAGbuHwS0zry6MMo61SQIade8rlDmy33Vlc&#39;</span>
<span class="n">API_ID</span> <span class="o">=</span> <span class="s1">&#39;27785340&#39;</span>
<span class="n">API_HASH</span> <span class="o">=</span> <span class="s1">&#39;cc6480b7fdc0d9561942c14ec989e731&#39;</span>

<span class="n">bot</span> <span class="o">=</span> <span class="n">Bot</span><span class="p">(</span><span class="n">token</span><span class="o">=</span><span class="n">API_TOKEN</span><span class="p">)</span>
<span class="n">dp</span> <span class="o">=</span> <span class="n">Dispatcher</span><span class="p">(</span><span class="n">storage</span><span class="o">=</span><span class="n">MemoryStorage</span><span class="p">())</span>

<span class="n">pyrogram_client</span> <span class="o">=</span> <span class="n">Client</span><span class="p">(</span><span class="s2">&quot;my_bot&quot;</span><span class="p">,</span> <span class="n">api_id</span><span class="o">=</span><span class="n">API_ID</span><span class="p">,</span> <span class="n">api_hash</span><span class="o">=</span><span class="n">API_HASH</span><span class="p">,</span> <span class="n">bot_token</span><span class="o">=</span><span class="n">API_TOKEN</span><span class="p">)</span>

<span class="n">ALLOWED_USERS</span> <span class="o">=</span> <span class="p">[]</span>  
<span class="n">SUPERUSERS</span> <span class="o">=</span> <span class="p">[</span><span class="mi">727262711</span><span class="p">]</span>  
<span class="n">GROUPS</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">GROUPS_FILTER_STATUS</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">GROUP_ID</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1002498829768</span>
<span class="n">DATE_REGEX</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;^\d</span><span class="si">{2}</span><span class="s1">\.\d</span><span class="si">{2}</span><span class="s1">\.\d</span><span class="si">{4}</span><span class="s1">$&#39;</span>

<span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">&#39;birthdays.db&#39;</span><span class="p">)</span>
<span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;CREATE TABLE IF NOT EXISTS users (</span>
<span class="s1">    id INTEGER PRIMARY KEY,</span>
<span class="s1">    tg_id INTEGER,</span>
<span class="s1">    full_name TEXT,</span>
<span class="s1">    birth_date DATE,</span>
<span class="s1">    gender TEXT,</span>
<span class="s1">    city TEXT,</span>
<span class="s1">    school TEXT,</span>
<span class="s1">    university TEXT, </span>
<span class="s1">    faculty TEXT,</span>
<span class="s1">    course TEXT,</span>
<span class="s1">    major TEXT,</span>
<span class="s1">    minor TEXT,</span>
<span class="s1">    dormitory TEXT,</span>
<span class="s1">    military_program TEXT,</span>
<span class="s1">    gift_wish TEXT</span>
<span class="s1">)&#39;&#39;&#39;</span><span class="p">)</span>
<span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>


<div class="viewcode-block" id="UserDataForm">
<a class="viewcode-back" href="../bot.html#bot.UserDataForm">[документация]</a>
<span class="k">class</span> <span class="nc">UserDataForm</span><span class="p">(</span><span class="n">StatesGroup</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Класс состояний для сбора данных от пользователя через шаги в форме.</span>

<span class="sd">    Атрибуты:</span>
<span class="sd">    ----------</span>
<span class="sd">    waiting_for_full_name : State</span>
<span class="sd">        Ожидание ввода полного имени пользователя (ФИО).</span>
<span class="sd">    waiting_for_gender : State</span>
<span class="sd">        Ожидание выбора пола пользователя.</span>
<span class="sd">    waiting_for_city : State</span>
<span class="sd">        Ожидание ввода города проживания пользователя.</span>
<span class="sd">    waiting_for_school : State</span>
<span class="sd">        Ожидание ввода учебного заведения пользователя.</span>
<span class="sd">    waiting_for_birth_date : State</span>
<span class="sd">        Ожидание ввода даты рождения пользователя.</span>
<span class="sd">    waiting_for_gift_wish : State</span>
<span class="sd">        Ожидание ввода пожелания на подарок от пользователя.</span>
<span class="sd">    waiting_for_university : State</span>
<span class="sd">        Ожидание ввода университета, если пользователь учится в вузе.</span>
<span class="sd">    waiting_for_faculty : State</span>
<span class="sd">        Ожидание ввода факультета пользователя.</span>
<span class="sd">    waiting_for_course : State</span>
<span class="sd">        Ожидание ввода курса обучения пользователя.</span>
<span class="sd">    waiting_for_major : State</span>
<span class="sd">        Ожидание ввода направления обучения пользователя.</span>
<span class="sd">    waiting_for_minor : State</span>
<span class="sd">        Ожидание ввода дополнительного направления (minor).</span>
<span class="sd">    waiting_for_military_program : State</span>
<span class="sd">        Ожидание ввода участия в военной программе.</span>
<span class="sd">    waiting_for_dormitory : State</span>
<span class="sd">        Ожидание информации о проживании в общежитии.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">waiting_for_full_name</span> <span class="o">=</span> <span class="n">State</span><span class="p">()</span>
    <span class="n">waiting_for_gender</span> <span class="o">=</span> <span class="n">State</span><span class="p">()</span>
    <span class="n">waiting_for_city</span> <span class="o">=</span> <span class="n">State</span><span class="p">()</span>
    <span class="n">waiting_for_school</span> <span class="o">=</span> <span class="n">State</span><span class="p">()</span>
    <span class="n">waiting_for_birth_date</span> <span class="o">=</span> <span class="n">State</span><span class="p">()</span>
    <span class="n">waiting_for_gift_wish</span> <span class="o">=</span> <span class="n">State</span><span class="p">()</span>
    <span class="n">waiting_for_university</span> <span class="o">=</span> <span class="n">State</span><span class="p">()</span> 
    <span class="n">waiting_for_faculty</span> <span class="o">=</span> <span class="n">State</span><span class="p">()</span>
    <span class="n">waiting_for_course</span> <span class="o">=</span> <span class="n">State</span><span class="p">()</span>
    <span class="n">waiting_for_major</span> <span class="o">=</span> <span class="n">State</span><span class="p">()</span>
    <span class="n">waiting_for_minor</span> <span class="o">=</span> <span class="n">State</span><span class="p">()</span>
    <span class="n">waiting_for_military_program</span> <span class="o">=</span> <span class="n">State</span><span class="p">()</span>
    <span class="n">waiting_for_dormitory</span> <span class="o">=</span> <span class="n">State</span><span class="p">()</span></div>


<div class="viewcode-block" id="BroadcastState">
<a class="viewcode-back" href="../bot.html#bot.BroadcastState">[документация]</a>
<span class="k">class</span> <span class="nc">BroadcastState</span><span class="p">(</span><span class="n">StatesGroup</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Класс состояний для управления рассылкой сообщений.</span>

<span class="sd">    Атрибуты:</span>
<span class="sd">    ----------</span>
<span class="sd">    waiting_for_message : State</span>
<span class="sd">        Ожидание ввода сообщения для рассылки.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">waiting_for_message</span> <span class="o">=</span> <span class="n">State</span><span class="p">()</span></div>


<div class="viewcode-block" id="load_bad_words">
<a class="viewcode-back" href="../bot.html#bot.load_bad_words">[документация]</a>
<span class="k">def</span> <span class="nf">load_bad_words</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Загружает список запрещённых слов из файла &#39;bad_words.txt&#39;.</span>
<span class="sd">    </span>
<span class="sd">    Возвращает:</span>
<span class="sd">    -----------</span>
<span class="sd">    list : Список запрещённых слов, отфильтрованных от пустых строк.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;../src/bad_words.txt&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span> <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span></div>


<div class="viewcode-block" id="load_birthday_messages">
<a class="viewcode-back" href="../bot.html#bot.load_birthday_messages">[документация]</a>
<span class="k">def</span> <span class="nf">load_birthday_messages</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s2">&quot;../src/birthday_messages.txt&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Загружает список сообщений для поздравлений с днями рождения из файла.</span>
<span class="sd">    </span>
<span class="sd">    Параметры:</span>
<span class="sd">    ----------</span>
<span class="sd">    filename : str</span>
<span class="sd">        Название файла с текстами сообщений. По умолчанию &#39;birthday_messages.txt&#39;.</span>
<span class="sd">    </span>
<span class="sd">    Возвращает:</span>
<span class="sd">    -----------</span>
<span class="sd">    list : Список поздравительных сообщений, разделённых по символу &#39;---&#39;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">message</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">message</span> <span class="ow">in</span> <span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;---&#39;</span><span class="p">)]</span>  </div>


<span class="n">birthday_messages</span> <span class="o">=</span> <span class="n">load_birthday_messages</span><span class="p">()</span>

<span class="n">bad_words</span> <span class="o">=</span> <span class="n">load_bad_words</span><span class="p">()</span>
<span class="n">bad_words_pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\b(?:&#39;</span> <span class="o">+</span> <span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
    <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">char</span> <span class="o">+</span> <span class="s1">&#39;{1,}&#39;</span> <span class="k">for</span> <span class="n">char</span> <span class="ow">in</span> <span class="n">word</span><span class="p">])</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">bad_words</span><span class="p">]</span>
<span class="p">)</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;)\b&#39;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span>

<div class="viewcode-block" id="setup_scheduler">
<a class="viewcode-back" href="../bot.html#bot.setup_scheduler">[документация]</a>
<span class="k">def</span> <span class="nf">setup_scheduler</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Настраивает и запускает планировщик задач для выполнения проверки дней рождений.</span>
<span class="sd">    </span>
<span class="sd">    Планировщик запускает задачу каждый день в 9:00.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">scheduler</span> <span class="o">=</span> <span class="n">AsyncIOScheduler</span><span class="p">()</span>
    <span class="n">scheduler</span><span class="o">.</span><span class="n">add_job</span><span class="p">(</span><span class="n">check_birthdays</span><span class="p">,</span> <span class="n">CronTrigger</span><span class="p">(</span><span class="n">hour</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span> <span class="n">minute</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
    <span class="n">scheduler</span><span class="o">.</span><span class="n">start</span><span class="p">()</span></div>


<div class="viewcode-block" id="on_startup">
<a class="viewcode-back" href="../bot.html#bot.on_startup">[документация]</a>
<span class="k">async</span> <span class="k">def</span> <span class="nf">on_startup</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Выполняется при запуске бота.</span>
<span class="sd">    </span>
<span class="sd">    Запускает планировщик задач и подключает pyrogram клиент.</span>
<span class="sd">    </span>
<span class="sd">    Параметры:</span>
<span class="sd">    ----------</span>
<span class="sd">    dp : Dispatcher</span>
<span class="sd">        Диспетчер Telegram-бота.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">setup_scheduler</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">pyrogram_client</span><span class="o">.</span><span class="n">is_connected</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">pyrogram_client</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Pyrogram client started&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="on_shutdown">
<a class="viewcode-back" href="../bot.html#bot.on_shutdown">[документация]</a>
<span class="k">async</span> <span class="k">def</span> <span class="nf">on_shutdown</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Выполняется при завершении работы бота.</span>
<span class="sd">    </span>
<span class="sd">    Останавливает pyrogram клиент.</span>
<span class="sd">    </span>
<span class="sd">    Параметры:</span>
<span class="sd">    ----------</span>
<span class="sd">    dp : Dispatcher</span>
<span class="sd">        Диспетчер Telegram-бота.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">pyrogram_client</span><span class="o">.</span><span class="n">is_connected</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">pyrogram_client</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Pyrogram client stopped&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="check_user_in_group">
<a class="viewcode-back" href="../bot.html#bot.check_user_in_group">[документация]</a>
<span class="k">async</span> <span class="k">def</span> <span class="nf">check_user_in_group</span><span class="p">(</span><span class="n">user_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Проверяет, является ли пользователь участником группы.</span>
<span class="sd">    </span>
<span class="sd">    Параметры:</span>
<span class="sd">    ----------</span>
<span class="sd">    user_id : int</span>
<span class="sd">        ID пользователя Telegram.</span>
<span class="sd">    </span>
<span class="sd">    Возвращает:</span>
<span class="sd">    -----------</span>
<span class="sd">    bool : True, если пользователь состоит в группе, иначе False.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">chat_member</span><span class="p">:</span> <span class="n">ChatMember</span> <span class="o">=</span> <span class="k">await</span> <span class="n">bot</span><span class="o">.</span><span class="n">get_chat_member</span><span class="p">(</span><span class="n">GROUP_ID</span><span class="p">,</span> <span class="n">user_id</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">chat_member</span><span class="o">.</span><span class="n">status</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;member&#39;</span><span class="p">,</span> <span class="s1">&#39;administrator&#39;</span><span class="p">,</span> <span class="s1">&#39;creator&#39;</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="is_user_registered">
<a class="viewcode-back" href="../bot.html#bot.is_user_registered">[документация]</a>
<span class="k">def</span> <span class="nf">is_user_registered</span><span class="p">(</span><span class="n">tg_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Проверяет, зарегистрирован ли пользователь в базе данных.</span>
<span class="sd">    </span>
<span class="sd">    Параметры:</span>
<span class="sd">    ----------</span>
<span class="sd">    tg_id : int</span>
<span class="sd">        ID пользователя Telegram.</span>
<span class="sd">    </span>
<span class="sd">    Возвращает:</span>
<span class="sd">    -----------</span>
<span class="sd">    bool : True, если пользователь зарегистрирован, иначе False.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT 1 FROM users WHERE tg_id = ?&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">tg_id</span><span class="p">,))</span>
    <span class="k">return</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="get_group_id">
<a class="viewcode-back" href="../bot.html#bot.get_group_id">[документация]</a>
<span class="k">async</span> <span class="k">def</span> <span class="nf">get_group_id</span><span class="p">(</span><span class="n">message</span><span class="p">:</span> <span class="n">types</span><span class="o">.</span><span class="n">Message</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Возвращает ID группы из сообщения или чата.</span>
<span class="sd">    </span>
<span class="sd">    Параметры:</span>
<span class="sd">    ----------</span>
<span class="sd">    message : types.Message</span>
<span class="sd">        Сообщение от пользователя Telegram.</span>
<span class="sd">    </span>
<span class="sd">    Возвращает:</span>
<span class="sd">    -----------</span>
<span class="sd">    int : ID чата.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">chat_id</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">chat</span><span class="o">.</span><span class="n">id</span>
    <span class="k">if</span> <span class="n">chat_id</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">chat_id</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">chat</span> <span class="o">=</span> <span class="k">await</span> <span class="n">pyrogram_client</span><span class="o">.</span><span class="n">get_chat</span><span class="p">(</span><span class="n">chat_id</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">chat</span><span class="o">.</span><span class="n">id</span></div>


<div class="viewcode-block" id="get_chat_members">
<a class="viewcode-back" href="../bot.html#bot.get_chat_members">[документация]</a>
<span class="k">async</span> <span class="k">def</span> <span class="nf">get_chat_members</span><span class="p">(</span><span class="n">chat_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Возвращает список участников чата.</span>
<span class="sd">    </span>
<span class="sd">    Параметры:</span>
<span class="sd">    ----------</span>
<span class="sd">    chat_id : int</span>
<span class="sd">        ID чата Telegram.</span>
<span class="sd">    </span>
<span class="sd">    Возвращает:</span>
<span class="sd">    -----------</span>
<span class="sd">    list : Список участников чата.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">members</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">async</span> <span class="k">for</span> <span class="n">member</span> <span class="ow">in</span> <span class="n">pyrogram_client</span><span class="o">.</span><span class="n">get_chat_members</span><span class="p">(</span><span class="n">chat_id</span><span class="p">):</span>
        <span class="n">members</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">member</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">members</span></div>


<div class="viewcode-block" id="is_valid_full_name">
<a class="viewcode-back" href="../bot.html#bot.is_valid_full_name">[документация]</a>
<span class="k">def</span> <span class="nf">is_valid_full_name</span><span class="p">(</span><span class="n">full_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Проверяет правильность ввода полного имени (ФИО).</span>
<span class="sd">    </span>
<span class="sd">    Параметры:</span>
<span class="sd">    ----------</span>
<span class="sd">    full_name : str</span>
<span class="sd">        Полное имя пользователя (ФИО).</span>
<span class="sd">    </span>
<span class="sd">    Возвращает:</span>
<span class="sd">    -----------</span>
<span class="sd">    bool : True, если ФИО соответствует шаблону (Фамилия Имя Отчество), иначе False.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">fullmatch</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;[А-ЯЁ][а-яё]+\s[А-ЯЁ][а-яё]+\s[А-ЯЁ][а-яё]+&#39;</span><span class="p">,</span> <span class="n">full_name</span><span class="p">))</span></div>


<div class="viewcode-block" id="is_valid_course">
<a class="viewcode-back" href="../bot.html#bot.is_valid_course">[документация]</a>
<span class="k">def</span> <span class="nf">is_valid_course</span><span class="p">(</span><span class="n">course</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Проверяет правильность ввода курса обучения.</span>
<span class="sd">    </span>
<span class="sd">    Параметры:</span>
<span class="sd">    ----------</span>
<span class="sd">    course : str</span>
<span class="sd">        Курс пользователя.</span>
<span class="sd">    </span>
<span class="sd">    Возвращает:</span>
<span class="sd">    -----------</span>
<span class="sd">    bool : True, если курс допустим (1-6, Магистратура, Аспирантура), иначе False.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">valid_courses</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="s2">&quot;2&quot;</span><span class="p">,</span> <span class="s2">&quot;3&quot;</span><span class="p">,</span> <span class="s2">&quot;4&quot;</span><span class="p">,</span> <span class="s2">&quot;5&quot;</span><span class="p">,</span> <span class="s2">&quot;6&quot;</span><span class="p">,</span> <span class="s2">&quot;Магистратура&quot;</span><span class="p">,</span> <span class="s2">&quot;Аспирантура&quot;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">course</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">valid_courses</span></div>


<div class="viewcode-block" id="check_birthdays">
<a class="viewcode-back" href="../bot.html#bot.check_birthdays">[документация]</a>
<span class="k">async</span> <span class="k">def</span> <span class="nf">check_birthdays</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Проверяет наличие дней рождений пользователей на текущую дату и отправляет поздравительные сообщения.</span>
<span class="sd">    </span>
<span class="sd">    Использует ФИО пользователя и пожелания на подарок для персонализации сообщений.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">today</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">.%m&quot;</span><span class="p">)</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT full_name, gift_wish FROM users WHERE birth_date LIKE ?&quot;</span><span class="p">,</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">today</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">,))</span>
    <span class="n">birthday_users</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Пользователи с днём рождения сегодня: </span><span class="si">{</span><span class="n">birthday_users</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">birthday_users</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">birthday_users</span><span class="p">:</span>
            <span class="n">full_name</span> <span class="o">=</span> <span class="n">user</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">gift_wish</span> <span class="o">=</span> <span class="n">user</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">name_parts</span> <span class="o">=</span> <span class="n">full_name</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">name_parts</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Некорректное ФИО: </span><span class="si">{</span><span class="n">full_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">continue</span>
            
            <span class="n">last_name</span> <span class="o">=</span> <span class="n">name_parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">first_name</span> <span class="o">=</span> <span class="n">name_parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            
            <span class="n">inflected_last_name</span> <span class="o">=</span> <span class="n">morph</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">last_name</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">inflect</span><span class="p">({</span><span class="s1">&#39;gent&#39;</span><span class="p">})</span><span class="o">.</span><span class="n">word</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span>
            <span class="n">inflected_first_name</span> <span class="o">=</span> <span class="n">morph</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">first_name</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">inflect</span><span class="p">({</span><span class="s1">&#39;gent&#39;</span><span class="p">})</span><span class="o">.</span><span class="n">word</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span>

            <span class="n">random_message</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">birthday_messages</span><span class="p">)</span>
            <span class="n">message</span> <span class="o">=</span> <span class="n">random_message</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">inflected_first_name</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">inflected_last_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">name1</span><span class="o">=</span><span class="n">first_name</span><span class="p">,</span> <span class="n">whish</span><span class="o">=</span><span class="n">gift_wish</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">bot</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span><span class="n">chat_id</span><span class="o">=</span><span class="s2">&quot;-1002498829768&quot;</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="n">message</span><span class="p">)</span></div>


<div class="viewcode-block" id="check_birthdays_daily">
<a class="viewcode-back" href="../bot.html#bot.check_birthdays_daily">[документация]</a>
<span class="k">async</span> <span class="k">def</span> <span class="nf">check_birthdays_daily</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Периодически проверяет дни рождения и отправляет поздравления дважды в день.</span>
<span class="sd">    </span>
<span class="sd">    Проверка выполняется в 00:00 и в 20:32 по московскому времени.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">moscow_tz</span> <span class="o">=</span> <span class="n">pytz</span><span class="o">.</span><span class="n">timezone</span><span class="p">(</span><span class="s1">&#39;Europe/Moscow&#39;</span><span class="p">)</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">moscow_tz</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">now</span><span class="o">.</span><span class="n">hour</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">now</span><span class="o">.</span><span class="n">minute</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">now</span><span class="o">.</span><span class="n">hour</span> <span class="o">==</span> <span class="mi">20</span> <span class="ow">and</span> <span class="n">now</span><span class="o">.</span><span class="n">minute</span> <span class="o">==</span> <span class="mi">32</span><span class="p">):</span>
            <span class="k">await</span> <span class="n">check_birthdays</span><span class="p">()</span>
            <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span></div>


<div class="viewcode-block" id="is_admin">
<a class="viewcode-back" href="../bot.html#bot.is_admin">[документация]</a>
<span class="k">async</span> <span class="k">def</span> <span class="nf">is_admin</span><span class="p">(</span><span class="n">message</span><span class="p">:</span> <span class="n">types</span><span class="o">.</span><span class="n">Message</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Проверяет, является ли пользователь администратором чата.</span>
<span class="sd">    </span>
<span class="sd">    Параметры:</span>
<span class="sd">    ----------</span>
<span class="sd">    message : types.Message</span>
<span class="sd">        Сообщение от пользователя Telegram.</span>
<span class="sd">    </span>
<span class="sd">    Возвращает:</span>
<span class="sd">    -----------</span>
<span class="sd">    bool : True, если пользователь является администратором, иначе False.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">chat_id</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">chat</span><span class="o">.</span><span class="n">id</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span>
    <span class="n">admins</span> <span class="o">=</span> <span class="k">await</span> <span class="n">bot</span><span class="o">.</span><span class="n">get_chat_administrators</span><span class="p">(</span><span class="n">chat_id</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">admin</span> <span class="ow">in</span> <span class="n">admins</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">admin</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">user_id</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
    <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="delete_previous_message">
<a class="viewcode-back" href="../bot.html#bot.delete_previous_message">[документация]</a>
<span class="k">async</span> <span class="k">def</span> <span class="nf">delete_previous_message</span><span class="p">(</span><span class="n">message</span><span class="p">:</span> <span class="n">types</span><span class="o">.</span><span class="n">Message</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">FSMContext</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Функция для удаления предыдущего сообщения пользователя и бота.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="k">await</span> <span class="n">state</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>
    <span class="n">previous_message_id</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;previous_message_id&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">previous_message_id</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">message</span><span class="o">.</span><span class="n">bot</span><span class="o">.</span><span class="n">delete_message</span><span class="p">(</span><span class="n">chat_id</span><span class="o">=</span><span class="n">message</span><span class="o">.</span><span class="n">chat</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">message_id</span><span class="o">=</span><span class="n">previous_message_id</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">pass</span>  <span class="c1"># Игнорируем ошибки удаления</span></div>


<div class="viewcode-block" id="delete_user_message">
<a class="viewcode-back" href="../bot.html#bot.delete_user_message">[документация]</a>
<span class="k">async</span> <span class="k">def</span> <span class="nf">delete_user_message</span><span class="p">(</span><span class="n">message</span><span class="p">:</span> <span class="n">types</span><span class="o">.</span><span class="n">Message</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Удаление сообщения пользователя.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">message</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">pass</span>  <span class="c1"># Игнорируем ошибки удаления</span></div>


<div class="viewcode-block" id="send_welcome">
<a class="viewcode-back" href="../bot.html#bot.send_welcome">[документация]</a>
<span class="nd">@dp</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="n">Command</span><span class="p">(</span><span class="s2">&quot;start&quot;</span><span class="p">))</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">send_welcome</span><span class="p">(</span><span class="n">message</span><span class="p">:</span> <span class="n">Message</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Приветственное сообщение при запуске команды /start.</span>
<span class="sd">    Показывает меню с опциями для взаимодействия с ботом.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">await</span> <span class="n">delete_user_message</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">message</span><span class="o">.</span><span class="n">chat</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;private&quot;</span><span class="p">:</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span>

        <span class="n">is_member</span> <span class="o">=</span> <span class="k">await</span> <span class="n">check_user_in_group</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_member</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">message</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;Вы не являетесь участником группы. Доступ к боту ограничен.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">keyboard</span> <span class="o">=</span> <span class="n">InlineKeyboardBuilder</span><span class="p">()</span>

            <span class="n">keyboard</span><span class="o">.</span><span class="n">row</span><span class="p">(</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s2">&quot;Записать мои данные&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;register_data&quot;</span><span class="p">))</span>
            <span class="n">keyboard</span><span class="o">.</span><span class="n">row</span><span class="p">(</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s2">&quot;Участники Землячества&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;save_data&quot;</span><span class="p">))</span>
            <span class="n">web_app</span> <span class="o">=</span> <span class="n">WebAppInfo</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="s2">&quot;https://alaniahse.ru&quot;</span><span class="p">)</span>
            <span class="n">keyboard</span><span class="o">.</span><span class="n">row</span><span class="p">(</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s2">&quot;Сайт землячества&quot;</span><span class="p">,</span> <span class="n">web_app</span><span class="o">=</span><span class="n">web_app</span><span class="p">))</span>

            <span class="n">bot_username</span> <span class="o">=</span> <span class="p">(</span><span class="k">await</span> <span class="n">bot</span><span class="o">.</span><span class="n">get_me</span><span class="p">())</span><span class="o">.</span><span class="n">username</span>
            <span class="n">add_bot_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;https://t.me/</span><span class="si">{</span><span class="n">bot_username</span><span class="si">}</span><span class="s2">?startgroup=true&quot;</span>
            <span class="n">keyboard</span><span class="o">.</span><span class="n">row</span><span class="p">(</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s2">&quot;Добавить бота в группу&quot;</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="n">add_bot_url</span><span class="p">))</span>

            <span class="k">await</span> <span class="n">message</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span>
                <span class="s2">&quot;Привет! Выберите действие ниже:&quot;</span><span class="p">,</span>
                <span class="n">reply_markup</span><span class="o">=</span><span class="n">keyboard</span><span class="o">.</span><span class="n">as_markup</span><span class="p">()</span>
            <span class="p">)</span></div>



<div class="viewcode-block" id="start_data_collection">
<a class="viewcode-back" href="../bot.html#bot.start_data_collection">[документация]</a>
<span class="nd">@dp</span><span class="o">.</span><span class="n">callback_query</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;register_data&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">start_data_collection</span><span class="p">(</span><span class="n">call</span><span class="p">:</span> <span class="n">types</span><span class="o">.</span><span class="n">CallbackQuery</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">FSMContext</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Начинает сбор данных пользователя при выборе опции &quot;Записать мои данные&quot;.</span>
<span class="sd">    Спрашивает полное имя (ФИО) у пользователя.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">await</span> <span class="n">delete_previous_message</span><span class="p">(</span><span class="n">call</span><span class="o">.</span><span class="n">message</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>

    <span class="n">sent_message</span> <span class="o">=</span> <span class="k">await</span> <span class="n">call</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;Пожалуйста, введите ваше полное имя (ФИО):&quot;</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">state</span><span class="o">.</span><span class="n">set_state</span><span class="p">(</span><span class="n">UserDataForm</span><span class="o">.</span><span class="n">waiting_for_full_name</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">state</span><span class="o">.</span><span class="n">update_data</span><span class="p">(</span><span class="n">previous_message_id</span><span class="o">=</span><span class="n">sent_message</span><span class="o">.</span><span class="n">message_id</span><span class="p">)</span></div>


<div class="viewcode-block" id="process_full_name">
<a class="viewcode-back" href="../bot.html#bot.process_full_name">[документация]</a>
<span class="nd">@dp</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="n">UserDataForm</span><span class="o">.</span><span class="n">waiting_for_full_name</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">process_full_name</span><span class="p">(</span><span class="n">message</span><span class="p">:</span> <span class="n">types</span><span class="o">.</span><span class="n">Message</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">FSMContext</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Обрабатывает введенное пользователем полное имя (ФИО).</span>
<span class="sd">    Проверяет корректность и предлагает выбрать пол.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">await</span> <span class="n">delete_user_message</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">delete_previous_message</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>

    <span class="n">full_name</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">text</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_valid_full_name</span><span class="p">(</span><span class="n">full_name</span><span class="p">):</span>
        <span class="n">sent_message</span> <span class="o">=</span> <span class="k">await</span> <span class="n">message</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;Некорректное ФИО. Пожалуйста, введите ФИО в формате: Иванов Иван Иванович.&quot;</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">state</span><span class="o">.</span><span class="n">update_data</span><span class="p">(</span><span class="n">previous_message_id</span><span class="o">=</span><span class="n">sent_message</span><span class="o">.</span><span class="n">message_id</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">await</span> <span class="n">state</span><span class="o">.</span><span class="n">update_data</span><span class="p">(</span><span class="n">full_name</span><span class="o">=</span><span class="n">full_name</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">state</span><span class="o">.</span><span class="n">update_data</span><span class="p">(</span><span class="n">tg_id</span><span class="o">=</span><span class="n">message</span><span class="o">.</span><span class="n">chat</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

    <span class="n">keyboard</span> <span class="o">=</span> <span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">inline_keyboard</span><span class="o">=</span><span class="p">[</span>
        <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s2">&quot;Мужчина&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;gender_male&quot;</span><span class="p">)],</span>
        <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s2">&quot;Женщина&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;gender_female&quot;</span><span class="p">)]</span>
    <span class="p">])</span>

    <span class="n">sent_message</span> <span class="o">=</span> <span class="k">await</span> <span class="n">message</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;Пожалуйста, выберите ваш пол:&quot;</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">keyboard</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">state</span><span class="o">.</span><span class="n">set_state</span><span class="p">(</span><span class="n">UserDataForm</span><span class="o">.</span><span class="n">waiting_for_gender</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">state</span><span class="o">.</span><span class="n">update_data</span><span class="p">(</span><span class="n">previous_message_id</span><span class="o">=</span><span class="n">sent_message</span><span class="o">.</span><span class="n">message_id</span><span class="p">)</span></div>


<div class="viewcode-block" id="process_gender">
<a class="viewcode-back" href="../bot.html#bot.process_gender">[документация]</a>
<span class="nd">@dp</span><span class="o">.</span><span class="n">callback_query</span><span class="p">(</span><span class="k">lambda</span> <span class="n">c</span><span class="p">:</span> <span class="n">c</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;gender_&#39;</span><span class="p">))</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">process_gender</span><span class="p">(</span><span class="n">call</span><span class="p">:</span> <span class="n">types</span><span class="o">.</span><span class="n">CallbackQuery</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">FSMContext</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Обрабатывает выбор пола пользователя и запрашивает родной город.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">await</span> <span class="n">delete_previous_message</span><span class="p">(</span><span class="n">call</span><span class="o">.</span><span class="n">message</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>

    <span class="n">gender</span> <span class="o">=</span> <span class="s1">&#39;Мужчина&#39;</span> <span class="k">if</span> <span class="n">call</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s1">&#39;gender_male&#39;</span> <span class="k">else</span> <span class="s1">&#39;Женщина&#39;</span>
    <span class="k">await</span> <span class="n">state</span><span class="o">.</span><span class="n">update_data</span><span class="p">(</span><span class="n">gender</span><span class="o">=</span><span class="n">gender</span><span class="p">)</span>

    <span class="n">sent_message</span> <span class="o">=</span> <span class="k">await</span> <span class="n">call</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;Введите ваш родной город:&quot;</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">state</span><span class="o">.</span><span class="n">set_state</span><span class="p">(</span><span class="n">UserDataForm</span><span class="o">.</span><span class="n">waiting_for_city</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">state</span><span class="o">.</span><span class="n">update_data</span><span class="p">(</span><span class="n">previous_message_id</span><span class="o">=</span><span class="n">sent_message</span><span class="o">.</span><span class="n">message_id</span><span class="p">)</span></div>


<div class="viewcode-block" id="process_city">
<a class="viewcode-back" href="../bot.html#bot.process_city">[документация]</a>
<span class="nd">@dp</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="n">UserDataForm</span><span class="o">.</span><span class="n">waiting_for_city</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">process_city</span><span class="p">(</span><span class="n">message</span><span class="p">:</span> <span class="n">types</span><span class="o">.</span><span class="n">Message</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">FSMContext</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Обрабатывает введенное название города, проверяет его длину.</span>
<span class="sd">    Предлагает выбрать университет, где учится пользователь.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">await</span> <span class="n">delete_user_message</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">delete_previous_message</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>

    <span class="n">city</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">city</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">sent_message</span> <span class="o">=</span> <span class="k">await</span> <span class="n">message</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;Название города слишком короткое. Попробуйте снова.&quot;</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">state</span><span class="o">.</span><span class="n">update_data</span><span class="p">(</span><span class="n">previous_message_id</span><span class="o">=</span><span class="n">sent_message</span><span class="o">.</span><span class="n">message_id</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">await</span> <span class="n">state</span><span class="o">.</span><span class="n">update_data</span><span class="p">(</span><span class="n">city</span><span class="o">=</span><span class="n">city</span><span class="p">)</span>

    <span class="n">keyboard</span> <span class="o">=</span> <span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">inline_keyboard</span><span class="o">=</span><span class="p">[</span>
        <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s2">&quot;Да, я учусь в ВШЭ&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;university_hse&quot;</span><span class="p">)],</span>
        <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s2">&quot;Нет, я учусь в другом вузе&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;university_other&quot;</span><span class="p">)]</span>
    <span class="p">])</span>

    <span class="n">sent_message</span> <span class="o">=</span> <span class="k">await</span> <span class="n">message</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;Вы учитесь в ВШЭ?&quot;</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">keyboard</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">state</span><span class="o">.</span><span class="n">update_data</span><span class="p">(</span><span class="n">previous_message_id</span><span class="o">=</span><span class="n">sent_message</span><span class="o">.</span><span class="n">message_id</span><span class="p">)</span></div>


<div class="viewcode-block" id="process_university">
<a class="viewcode-back" href="../bot.html#bot.process_university">[документация]</a>
<span class="nd">@dp</span><span class="o">.</span><span class="n">callback_query</span><span class="p">(</span><span class="k">lambda</span> <span class="n">c</span><span class="p">:</span> <span class="n">c</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;university_hse&quot;</span> <span class="ow">or</span> <span class="n">c</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;university_other&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">process_university</span><span class="p">(</span><span class="n">call</span><span class="p">:</span> <span class="n">types</span><span class="o">.</span><span class="n">CallbackQuery</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">FSMContext</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Обрабатывает выбор университета и запрашивает школу.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">await</span> <span class="n">delete_previous_message</span><span class="p">(</span><span class="n">call</span><span class="o">.</span><span class="n">message</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">call</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;university_hse&quot;</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">state</span><span class="o">.</span><span class="n">update_data</span><span class="p">(</span><span class="n">university</span><span class="o">=</span><span class="s2">&quot;ВШЭ&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">state</span><span class="o">.</span><span class="n">update_data</span><span class="p">(</span><span class="n">university</span><span class="o">=</span><span class="s2">&quot;Другой ВУЗ&quot;</span><span class="p">)</span>

    <span class="n">sent_message</span> <span class="o">=</span> <span class="k">await</span> <span class="n">call</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;Введите название вашей школы:&quot;</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">state</span><span class="o">.</span><span class="n">set_state</span><span class="p">(</span><span class="n">UserDataForm</span><span class="o">.</span><span class="n">waiting_for_school</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">state</span><span class="o">.</span><span class="n">update_data</span><span class="p">(</span><span class="n">previous_message_id</span><span class="o">=</span><span class="n">sent_message</span><span class="o">.</span><span class="n">message_id</span><span class="p">)</span></div>


<div class="viewcode-block" id="process_school">
<a class="viewcode-back" href="../bot.html#bot.process_school">[документация]</a>
<span class="nd">@dp</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="n">UserDataForm</span><span class="o">.</span><span class="n">waiting_for_school</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">process_school</span><span class="p">(</span><span class="n">message</span><span class="p">:</span> <span class="n">types</span><span class="o">.</span><span class="n">Message</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">FSMContext</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Обрабатывает название школы и запрашивает дату рождения.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">await</span> <span class="n">delete_user_message</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">delete_previous_message</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>

    <span class="n">school</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">school</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">sent_message</span> <span class="o">=</span> <span class="k">await</span> <span class="n">message</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;Название школы слишком короткое. Попробуйте снова.&quot;</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">state</span><span class="o">.</span><span class="n">update_data</span><span class="p">(</span><span class="n">previous_message_id</span><span class="o">=</span><span class="n">sent_message</span><span class="o">.</span><span class="n">message_id</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">await</span> <span class="n">state</span><span class="o">.</span><span class="n">update_data</span><span class="p">(</span><span class="n">school</span><span class="o">=</span><span class="n">school</span><span class="p">)</span>

    <span class="n">sent_message</span> <span class="o">=</span> <span class="k">await</span> <span class="n">message</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;Введите вашу дату рождения в формате ДД.ММ.ГГГГ:&quot;</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">state</span><span class="o">.</span><span class="n">set_state</span><span class="p">(</span><span class="n">UserDataForm</span><span class="o">.</span><span class="n">waiting_for_birth_date</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">state</span><span class="o">.</span><span class="n">update_data</span><span class="p">(</span><span class="n">previous_message_id</span><span class="o">=</span><span class="n">sent_message</span><span class="o">.</span><span class="n">message_id</span><span class="p">)</span></div>


<div class="viewcode-block" id="process_birth_date">
<a class="viewcode-back" href="../bot.html#bot.process_birth_date">[документация]</a>
<span class="nd">@dp</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="n">UserDataForm</span><span class="o">.</span><span class="n">waiting_for_birth_date</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">process_birth_date</span><span class="p">(</span><span class="n">message</span><span class="p">:</span> <span class="n">types</span><span class="o">.</span><span class="n">Message</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">FSMContext</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Обрабатывает введенную дату рождения, проверяет её корректность.</span>
<span class="sd">    Предлагает ввести пожелание к подарку.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">await</span> <span class="n">delete_user_message</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">delete_previous_message</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>

    <span class="n">birth_date</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">DATE_REGEX</span><span class="p">,</span> <span class="n">birth_date</span><span class="p">):</span>
        <span class="n">sent_message</span> <span class="o">=</span> <span class="k">await</span> <span class="n">message</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;Неверный формат даты. Введите дату в формате ДД.ММ.ГГГГ:&quot;</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">state</span><span class="o">.</span><span class="n">update_data</span><span class="p">(</span><span class="n">previous_message_id</span><span class="o">=</span><span class="n">sent_message</span><span class="o">.</span><span class="n">message_id</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">await</span> <span class="n">state</span><span class="o">.</span><span class="n">update_data</span><span class="p">(</span><span class="n">birth_date</span><span class="o">=</span><span class="n">birth_date</span><span class="p">)</span>

    <span class="n">sent_message</span> <span class="o">=</span> <span class="k">await</span> <span class="n">message</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;Введите ваше пожелание на подарок:&quot;</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">state</span><span class="o">.</span><span class="n">set_state</span><span class="p">(</span><span class="n">UserDataForm</span><span class="o">.</span><span class="n">waiting_for_gift_wish</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">state</span><span class="o">.</span><span class="n">update_data</span><span class="p">(</span><span class="n">previous_message_id</span><span class="o">=</span><span class="n">sent_message</span><span class="o">.</span><span class="n">message_id</span><span class="p">)</span></div>


<div class="viewcode-block" id="process_gift_wish">
<a class="viewcode-back" href="../bot.html#bot.process_gift_wish">[документация]</a>
<span class="nd">@dp</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="n">UserDataForm</span><span class="o">.</span><span class="n">waiting_for_gift_wish</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">process_gift_wish</span><span class="p">(</span><span class="n">message</span><span class="p">:</span> <span class="n">types</span><span class="o">.</span><span class="n">Message</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">FSMContext</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Обрабатывает пожелание на подарок и предлагает выбрать факультет.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">await</span> <span class="n">delete_user_message</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">delete_previous_message</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>

    <span class="n">gift_wish</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="k">await</span> <span class="n">state</span><span class="o">.</span><span class="n">update_data</span><span class="p">(</span><span class="n">gift_wish</span><span class="o">=</span><span class="n">gift_wish</span><span class="p">)</span>

    <span class="n">sent_message</span> <span class="o">=</span> <span class="k">await</span> <span class="n">message</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;Введите ваш факультет:&quot;</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">state</span><span class="o">.</span><span class="n">set_state</span><span class="p">(</span><span class="n">UserDataForm</span><span class="o">.</span><span class="n">waiting_for_faculty</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">state</span><span class="o">.</span><span class="n">update_data</span><span class="p">(</span><span class="n">previous_message_id</span><span class="o">=</span><span class="n">sent_message</span><span class="o">.</span><span class="n">message_id</span><span class="p">)</span></div>


<div class="viewcode-block" id="process_faculty">
<a class="viewcode-back" href="../bot.html#bot.process_faculty">[документация]</a>
<span class="nd">@dp</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="n">UserDataForm</span><span class="o">.</span><span class="n">waiting_for_faculty</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">process_faculty</span><span class="p">(</span><span class="n">message</span><span class="p">:</span> <span class="n">types</span><span class="o">.</span><span class="n">Message</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">FSMContext</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Обрабатывает введенное название факультета и запрашивает курс.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">await</span> <span class="n">delete_user_message</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">delete_previous_message</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>

    <span class="n">faculty</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">faculty</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">sent_message</span> <span class="o">=</span> <span class="k">await</span> <span class="n">message</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;Название факультета слишком короткое. Попробуйте снова.&quot;</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">state</span><span class="o">.</span><span class="n">update_data</span><span class="p">(</span><span class="n">previous_message_id</span><span class="o">=</span><span class="n">sent_message</span><span class="o">.</span><span class="n">message_id</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">await</span> <span class="n">state</span><span class="o">.</span><span class="n">update_data</span><span class="p">(</span><span class="n">faculty</span><span class="o">=</span><span class="n">faculty</span><span class="p">)</span>

    <span class="n">keyboard</span> <span class="o">=</span> <span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">inline_keyboard</span><span class="o">=</span><span class="p">[</span>
        <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s2">&quot;1 курс&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;course_1&quot;</span><span class="p">)],</span>
        <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s2">&quot;2 курс&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;course_2&quot;</span><span class="p">)],</span>
        <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s2">&quot;3 курс&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;course_3&quot;</span><span class="p">)],</span>
        <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s2">&quot;4 курс&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;course_4&quot;</span><span class="p">)]</span>
    <span class="p">])</span>

    <span class="n">sent_message</span> <span class="o">=</span> <span class="k">await</span> <span class="n">message</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;Выберите ваш курс:&quot;</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">keyboard</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">state</span><span class="o">.</span><span class="n">update_data</span><span class="p">(</span><span class="n">previous_message_id</span><span class="o">=</span><span class="n">sent_message</span><span class="o">.</span><span class="n">message_id</span><span class="p">)</span></div>


<div class="viewcode-block" id="process_course">
<a class="viewcode-back" href="../bot.html#bot.process_course">[документация]</a>
<span class="nd">@dp</span><span class="o">.</span><span class="n">callback_query</span><span class="p">(</span><span class="k">lambda</span> <span class="n">c</span><span class="p">:</span> <span class="n">c</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;course_&#39;</span><span class="p">))</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">process_course</span><span class="p">(</span><span class="n">call</span><span class="p">:</span> <span class="n">types</span><span class="o">.</span><span class="n">CallbackQuery</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">FSMContext</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Обрабатывает выбор курса и запрашивает направление подготовки.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">await</span> <span class="n">delete_previous_message</span><span class="p">(</span><span class="n">call</span><span class="o">.</span><span class="n">message</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>

    <span class="n">course</span> <span class="o">=</span> <span class="n">call</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">await</span> <span class="n">state</span><span class="o">.</span><span class="n">update_data</span><span class="p">(</span><span class="n">course</span><span class="o">=</span><span class="n">course</span><span class="p">)</span>

    <span class="n">sent_message</span> <span class="o">=</span> <span class="k">await</span> <span class="n">call</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;Введите ваше направление подготовки:&quot;</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">state</span><span class="o">.</span><span class="n">set_state</span><span class="p">(</span><span class="n">UserDataForm</span><span class="o">.</span><span class="n">waiting_for_major</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">state</span><span class="o">.</span><span class="n">update_data</span><span class="p">(</span><span class="n">previous_message_id</span><span class="o">=</span><span class="n">sent_message</span><span class="o">.</span><span class="n">message_id</span><span class="p">)</span></div>


<div class="viewcode-block" id="process_major">
<a class="viewcode-back" href="../bot.html#bot.process_major">[документация]</a>
<span class="nd">@dp</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="n">UserDataForm</span><span class="o">.</span><span class="n">waiting_for_major</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">process_major</span><span class="p">(</span><span class="n">message</span><span class="p">:</span> <span class="n">types</span><span class="o">.</span><span class="n">Message</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">FSMContext</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Обрабатывает введенное направление подготовки и спрашивает про наличие военной кафедры.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">await</span> <span class="n">delete_user_message</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">delete_previous_message</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>

    <span class="n">major</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">major</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">sent_message</span> <span class="o">=</span> <span class="k">await</span> <span class="n">message</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;Название направления слишком короткое. Попробуйте снова.&quot;</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">state</span><span class="o">.</span><span class="n">update_data</span><span class="p">(</span><span class="n">previous_message_id</span><span class="o">=</span><span class="n">sent_message</span><span class="o">.</span><span class="n">message_id</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">await</span> <span class="n">state</span><span class="o">.</span><span class="n">update_data</span><span class="p">(</span><span class="n">major</span><span class="o">=</span><span class="n">major</span><span class="p">)</span>

    <span class="n">keyboard</span> <span class="o">=</span> <span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">inline_keyboard</span><span class="o">=</span><span class="p">[</span>
        <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s2">&quot;Да, есть&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;military_yes&quot;</span><span class="p">)],</span>
        <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s2">&quot;Нет, нету&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;military_no&quot;</span><span class="p">)]</span>
    <span class="p">])</span>

    <span class="n">sent_message</span> <span class="o">=</span> <span class="k">await</span> <span class="n">message</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;Есть ли у вас военная кафедра?&quot;</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">keyboard</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">state</span><span class="o">.</span><span class="n">update_data</span><span class="p">(</span><span class="n">previous_message_id</span><span class="o">=</span><span class="n">sent_message</span><span class="o">.</span><span class="n">message_id</span><span class="p">)</span></div>


<div class="viewcode-block" id="process_military_program">
<a class="viewcode-back" href="../bot.html#bot.process_military_program">[документация]</a>
<span class="nd">@dp</span><span class="o">.</span><span class="n">callback_query</span><span class="p">(</span><span class="k">lambda</span> <span class="n">c</span><span class="p">:</span> <span class="n">c</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;military_&#39;</span><span class="p">))</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">process_military_program</span><span class="p">(</span><span class="n">call</span><span class="p">:</span> <span class="n">types</span><span class="o">.</span><span class="n">CallbackQuery</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">FSMContext</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Обрабатывает выбор о наличии военной кафедры и спрашивает про общежитие.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">await</span> <span class="n">delete_previous_message</span><span class="p">(</span><span class="n">call</span><span class="o">.</span><span class="n">message</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>

    <span class="n">military_program</span> <span class="o">=</span> <span class="s1">&#39;Есть&#39;</span> <span class="k">if</span> <span class="n">call</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s1">&#39;military_yes&#39;</span> <span class="k">else</span> <span class="s1">&#39;Нет&#39;</span>
    <span class="k">await</span> <span class="n">state</span><span class="o">.</span><span class="n">update_data</span><span class="p">(</span><span class="n">military_program</span><span class="o">=</span><span class="n">military_program</span><span class="p">)</span>

    <span class="n">keyboard</span> <span class="o">=</span> <span class="n">InlineKeyboardMarkup</span><span class="p">(</span><span class="n">inline_keyboard</span><span class="o">=</span><span class="p">[</span>
        <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s2">&quot;Да, есть&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;dormitory_yes&quot;</span><span class="p">)],</span>
        <span class="p">[</span><span class="n">InlineKeyboardButton</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s2">&quot;Нет, нету&quot;</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="s2">&quot;dormitory_no&quot;</span><span class="p">)]</span>
    <span class="p">])</span>

    <span class="n">sent_message</span> <span class="o">=</span> <span class="k">await</span> <span class="n">call</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;Есть ли у вас общежитие?&quot;</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">keyboard</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">state</span><span class="o">.</span><span class="n">set_state</span><span class="p">(</span><span class="n">UserDataForm</span><span class="o">.</span><span class="n">waiting_for_dormitory</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">state</span><span class="o">.</span><span class="n">update_data</span><span class="p">(</span><span class="n">previous_message_id</span><span class="o">=</span><span class="n">sent_message</span><span class="o">.</span><span class="n">message_id</span><span class="p">)</span></div>


<div class="viewcode-block" id="process_dormitory">
<a class="viewcode-back" href="../bot.html#bot.process_dormitory">[документация]</a>
<span class="nd">@dp</span><span class="o">.</span><span class="n">callback_query</span><span class="p">(</span><span class="k">lambda</span> <span class="n">c</span><span class="p">:</span> <span class="n">c</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;dormitory_&#39;</span><span class="p">))</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">process_dormitory</span><span class="p">(</span><span class="n">call</span><span class="p">:</span> <span class="n">types</span><span class="o">.</span><span class="n">CallbackQuery</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">FSMContext</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Обрабатывает выбор о наличии общежития и завершает сбор данных.</span>
<span class="sd">    Сохраняет все введенные данные в базе.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">await</span> <span class="n">delete_previous_message</span><span class="p">(</span><span class="n">call</span><span class="o">.</span><span class="n">message</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>

    <span class="n">dormitory</span> <span class="o">=</span> <span class="s1">&#39;Есть&#39;</span> <span class="k">if</span> <span class="n">call</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s1">&#39;dormitory_yes&#39;</span> <span class="k">else</span> <span class="s1">&#39;Нет&#39;</span>
    <span class="k">await</span> <span class="n">state</span><span class="o">.</span><span class="n">update_data</span><span class="p">(</span><span class="n">dormitory</span><span class="o">=</span><span class="n">dormitory</span><span class="p">)</span>

    <span class="c1"># Получаем все данные пользователя</span>
    <span class="n">user_data</span> <span class="o">=</span> <span class="k">await</span> <span class="n">state</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>

    <span class="c1"># Сохранение данных в базе данных</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">        INSERT INTO users (tg_id, full_name, gender, city, university, school, birth_date, gift_wish, faculty, course, major, military_program, dormitory)</span>
<span class="s1">        VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)</span>
<span class="s1">    &#39;&#39;&#39;</span><span class="p">,</span> <span class="p">(</span>
        <span class="n">user_data</span><span class="p">[</span><span class="s1">&#39;tg_id&#39;</span><span class="p">],</span> <span class="n">user_data</span><span class="p">[</span><span class="s1">&#39;full_name&#39;</span><span class="p">],</span> <span class="n">user_data</span><span class="p">[</span><span class="s1">&#39;gender&#39;</span><span class="p">],</span> <span class="n">user_data</span><span class="p">[</span><span class="s1">&#39;city&#39;</span><span class="p">],</span>
        <span class="n">user_data</span><span class="p">[</span><span class="s1">&#39;university&#39;</span><span class="p">],</span> <span class="n">user_data</span><span class="p">[</span><span class="s1">&#39;school&#39;</span><span class="p">],</span> <span class="n">user_data</span><span class="p">[</span><span class="s1">&#39;birth_date&#39;</span><span class="p">],</span> <span class="n">user_data</span><span class="p">[</span><span class="s1">&#39;gift_wish&#39;</span><span class="p">],</span>
        <span class="n">user_data</span><span class="p">[</span><span class="s1">&#39;faculty&#39;</span><span class="p">],</span> <span class="n">user_data</span><span class="p">[</span><span class="s1">&#39;course&#39;</span><span class="p">],</span> <span class="n">user_data</span><span class="p">[</span><span class="s1">&#39;major&#39;</span><span class="p">],</span> <span class="n">user_data</span><span class="p">[</span><span class="s1">&#39;military_program&#39;</span><span class="p">],</span>
        <span class="n">user_data</span><span class="p">[</span><span class="s1">&#39;dormitory&#39;</span><span class="p">]</span>
    <span class="p">))</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

    <span class="n">sent_message</span> <span class="o">=</span> <span class="k">await</span> <span class="n">call</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;Спасибо! Ваши данные успешно сохранены.&quot;</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">state</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>
    <span class="k">await</span> <span class="n">state</span><span class="o">.</span><span class="n">update_data</span><span class="p">(</span><span class="n">previous_message_id</span><span class="o">=</span><span class="n">sent_message</span><span class="o">.</span><span class="n">message_id</span><span class="p">)</span></div>


    

<div class="viewcode-block" id="is_filtering_enabled">
<a class="viewcode-back" href="../bot.html#bot.is_filtering_enabled">[документация]</a>
<span class="k">def</span> <span class="nf">is_filtering_enabled</span><span class="p">(</span><span class="n">chat_id</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">GROUPS_FILTER_STATUS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">chat_id</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span></div>


<div class="viewcode-block" id="export_excel">
<a class="viewcode-back" href="../bot.html#bot.export_excel">[документация]</a>
<span class="nd">@dp</span><span class="o">.</span><span class="n">callback_query</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;save_data&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">export_excel</span><span class="p">(</span><span class="n">callback</span><span class="p">:</span> <span class="n">CallbackQuery</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Экспортирует данные пользователей в Excel и отправляет файл пользователю, если он зарегистрирован.</span>

<span class="sd">    Эта функция выполняет следующие действия:</span>
<span class="sd">    1. Извлекает данные пользователей из базы данных.</span>
<span class="sd">    2. Формирует DataFrame с полученными данными и сохраняет его в Excel-файл.</span>
<span class="sd">    3. Применяет стили к заголовкам и данным в таблице (шрифт, выравнивание, ширина столбцов).</span>
<span class="sd">    4. Проверяет, зарегистрирован ли пользователь, инициировавший запрос, в базе данных.</span>
<span class="sd">    5. Если пользователь зарегистрирован, отправляет ему Excel-файл.</span>
<span class="sd">    6. Если нет, выводит сообщение, что необходимо зарегистрироваться.</span>

<span class="sd">    Аргументы:</span>
<span class="sd">    callback (CallbackQuery): Объект CallbackQuery, содержащий информацию о запросе от пользователя.</span>

<span class="sd">    Исключения:</span>
<span class="sd">    None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT full_name, birth_date, gender, city, university, faculty, course, major, minor, military_program, dormitory, school, gift_wish FROM users&quot;</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
    <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">description</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">description</span> <span class="ow">in</span> <span class="n">cursor</span><span class="o">.</span><span class="n">description</span><span class="p">]</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">columns</span><span class="p">)</span>
    <span class="n">file_path</span> <span class="o">=</span> <span class="s2">&quot;src/birthdays.xlsx&quot;</span>

    <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ФИО&#39;</span><span class="p">,</span> <span class="s1">&#39;Дата рождения&#39;</span><span class="p">,</span> <span class="s1">&#39;Пол&#39;</span><span class="p">,</span> <span class="s1">&#39;Город&#39;</span><span class="p">,</span> <span class="s1">&#39;Вуз&#39;</span><span class="p">,</span> <span class="s1">&#39;Факультет&#39;</span><span class="p">,</span> <span class="s1">&#39;Курс&#39;</span><span class="p">,</span> <span class="s1">&#39;Направление&#39;</span><span class="p">,</span> <span class="s1">&#39;Майнор&#39;</span><span class="p">,</span> <span class="s1">&#39;Военная программа&#39;</span><span class="p">,</span> <span class="s1">&#39;Общежитие&#39;</span><span class="p">,</span> <span class="s1">&#39;Школа&#39;</span><span class="p">,</span> <span class="s1">&#39;Пожелания&#39;</span><span class="p">]</span>
    <span class="n">df</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">wb</span> <span class="o">=</span> <span class="n">load_workbook</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
    <span class="n">ws</span> <span class="o">=</span> <span class="n">wb</span><span class="o">.</span><span class="n">active</span>

    <span class="n">header_font</span> <span class="o">=</span> <span class="n">Font</span><span class="p">(</span><span class="n">bold</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;ffffff&quot;</span><span class="p">)</span>
    <span class="n">header_fill</span> <span class="o">=</span> <span class="n">PatternFill</span><span class="p">(</span><span class="s2">&quot;solid&quot;</span><span class="p">,</span> <span class="n">fgColor</span><span class="o">=</span><span class="s2">&quot;008080&quot;</span><span class="p">)</span>
    <span class="n">center_alignment</span> <span class="o">=</span> <span class="n">Alignment</span><span class="p">(</span><span class="n">horizontal</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span> <span class="n">vertical</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span> <span class="n">wrap_text</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

   
    <span class="k">for</span> <span class="n">col_num</span><span class="p">,</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ws</span><span class="o">.</span><span class="n">iter_cols</span><span class="p">(</span><span class="n">min_row</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_row</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">min_col</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_col</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)),</span> <span class="mi">1</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="n">col</span><span class="p">:</span>
            <span class="n">cell</span><span class="o">.</span><span class="n">font</span> <span class="o">=</span> <span class="n">header_font</span>
            <span class="n">cell</span><span class="o">.</span><span class="n">fill</span> <span class="o">=</span> <span class="n">header_fill</span>
            <span class="n">cell</span><span class="o">.</span><span class="n">alignment</span> <span class="o">=</span> <span class="n">center_alignment</span>
            <span class="n">ws</span><span class="o">.</span><span class="n">column_dimensions</span><span class="p">[</span><span class="n">get_column_letter</span><span class="p">(</span><span class="n">col_num</span><span class="p">)]</span><span class="o">.</span><span class="n">width</span> <span class="o">=</span> <span class="mi">30</span>

   
    <span class="n">cell_font</span> <span class="o">=</span> <span class="n">Font</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">ws</span><span class="o">.</span><span class="n">iter_rows</span><span class="p">(</span><span class="n">min_row</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">max_row</span><span class="o">=</span><span class="n">ws</span><span class="o">.</span><span class="n">max_row</span><span class="p">,</span> <span class="n">min_col</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_col</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)):</span>
        <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="n">row</span><span class="p">:</span>
            <span class="n">cell</span><span class="o">.</span><span class="n">alignment</span> <span class="o">=</span> <span class="n">Alignment</span><span class="p">(</span><span class="n">horizontal</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span> <span class="n">vertical</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span> <span class="n">wrap_text</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">cell</span><span class="o">.</span><span class="n">font</span> <span class="o">=</span> <span class="n">cell_font</span>
            <span class="n">ws</span><span class="o">.</span><span class="n">row_dimensions</span><span class="p">[</span><span class="n">cell</span><span class="o">.</span><span class="n">row</span><span class="p">]</span><span class="o">.</span><span class="n">height</span> <span class="o">=</span> <span class="mi">77</span>  

   
    <span class="n">wb</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>

    
    <span class="k">if</span> <span class="n">is_user_registered</span><span class="p">(</span><span class="n">callback</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">chat</span><span class="o">.</span><span class="n">id</span><span class="p">):</span>
        <span class="n">input_file</span> <span class="o">=</span> <span class="n">FSInputFile</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">callback</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">answer_document</span><span class="p">(</span><span class="n">input_file</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">callback</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;Чтобы увидеть таблицу с участниками, вы сами должны быть там)&quot;</span><span class="p">)</span>

    <span class="k">await</span> <span class="n">callback</span><span class="o">.</span><span class="n">answer</span><span class="p">()</span></div>




<div class="viewcode-block" id="enable_filter">
<a class="viewcode-back" href="../bot.html#bot.enable_filter">[документация]</a>
<span class="nd">@dp</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="n">Command</span><span class="p">(</span><span class="s2">&quot;enable_filter&quot;</span><span class="p">))</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">enable_filter</span><span class="p">(</span><span class="n">message</span><span class="p">:</span> <span class="n">types</span><span class="o">.</span><span class="n">Message</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Включает фильтрацию ненормативной лексики для группы.</span>

<span class="sd">    Эта команда доступна только администраторам. При её активации для группы включается фильтрация нецензурных слов.</span>

<span class="sd">    Аргументы:</span>
<span class="sd">    message (types.Message): Сообщение от пользователя с командой.</span>

<span class="sd">    Исключения:</span>
<span class="sd">    Отправляет сообщение об ошибке, если пользователь не является администратором.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">message</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">SUPERUSERS</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">message</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;У вас нет прав для использования этой команды.&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="n">chat_id</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">chat</span><span class="o">.</span><span class="n">id</span>
    <span class="n">GROUPS_FILTER_STATUS</span><span class="p">[</span><span class="n">chat_id</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">await</span> <span class="n">message</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;Фильтрация мата включена для этой группы.&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="disable_filter">
<a class="viewcode-back" href="../bot.html#bot.disable_filter">[документация]</a>
<span class="nd">@dp</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="n">Command</span><span class="p">(</span><span class="s2">&quot;disable_filter&quot;</span><span class="p">))</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">disable_filter</span><span class="p">(</span><span class="n">message</span><span class="p">:</span> <span class="n">types</span><span class="o">.</span><span class="n">Message</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Отключает фильтрацию ненормативной лексики для группы.</span>

<span class="sd">    Эта команда доступна только администраторам. При её активации для группы отключается фильтрация нецензурных слов.</span>

<span class="sd">    Аргументы:</span>
<span class="sd">    message (types.Message): Сообщение от пользователя с командой.</span>

<span class="sd">    Исключения:</span>
<span class="sd">    Отправляет сообщение об ошибке, если пользователь не является администратором.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">message</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">SUPERUSERS</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">message</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;У вас нет прав для использования этой команды.&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="n">chat_id</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">chat</span><span class="o">.</span><span class="n">id</span>
    <span class="n">GROUPS_FILTER_STATUS</span><span class="p">[</span><span class="n">chat_id</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">await</span> <span class="n">message</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;Фильтрация мата отключена для этой группы.&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="filter_bad_words">
<a class="viewcode-back" href="../bot.html#bot.filter_bad_words">[документация]</a>
<span class="nd">@dp</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="k">lambda</span> <span class="n">message</span><span class="p">:</span> <span class="n">message</span><span class="o">.</span><span class="n">chat</span><span class="o">.</span><span class="n">type</span> <span class="ow">in</span> <span class="p">[</span><span class="n">ChatType</span><span class="o">.</span><span class="n">GROUP</span><span class="p">,</span> <span class="n">ChatType</span><span class="o">.</span><span class="n">SUPERGROUP</span><span class="p">])</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">filter_bad_words</span><span class="p">(</span><span class="n">message</span><span class="p">:</span> <span class="n">Message</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Фильтрует сообщения с ненормативной лексикой в группе.</span>

<span class="sd">    Если в группе включена фильтрация ненормативной лексики, эта функция удаляет сообщения, содержащие запрещённые слова, и уведомляет участников о причине удаления.</span>

<span class="sd">    Аргументы:</span>
<span class="sd">    message (Message): Сообщение, которое нужно проверить на наличие нецензурных слов.</span>

<span class="sd">    Исключения:</span>
<span class="sd">    None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">is_filtering_enabled</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">chat</span><span class="o">.</span><span class="n">id</span><span class="p">):</span> 
        <span class="k">if</span> <span class="n">message</span><span class="o">.</span><span class="n">text</span> <span class="ow">and</span> <span class="n">bad_words_pattern</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">text</span><span class="p">):</span>
            <span class="k">await</span> <span class="n">message</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span> 
            <span class="k">await</span> <span class="n">message</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;Сообщение было удалено из-за ненормативной лексики.&quot;</span><span class="p">)</span></div>




<div class="viewcode-block" id="tag_all">
<a class="viewcode-back" href="../bot.html#bot.tag_all">[документация]</a>
<span class="nd">@dp</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="n">Command</span><span class="p">(</span><span class="s2">&quot;all&quot;</span><span class="p">))</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">tag_all</span><span class="p">(</span><span class="n">message</span><span class="p">:</span> <span class="n">types</span><span class="o">.</span><span class="n">Message</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Упоминает всех участников группы, кроме ботов.</span>

<span class="sd">    Эта команда доступна только администраторам. Она генерирует список упоминаний всех участников группы и отправляет их в несколько сообщений, если количество упоминаний превышает лимит.</span>

<span class="sd">    Аргументы:</span>
<span class="sd">    message (types.Message): Сообщение от администратора группы с командой.</span>

<span class="sd">    Исключения:</span>
<span class="sd">    Отправляет сообщение об ошибке, если пользователь не является администратором.</span>
<span class="sd">    &quot;&quot;&quot;</span>  
    <span class="k">if</span> <span class="ow">not</span> <span class="k">await</span> <span class="n">is_admin</span><span class="p">(</span><span class="n">message</span><span class="p">)</span> <span class="ow">and</span> <span class="n">message</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">SUPERUSERS</span><span class="p">:</span>
        <span class="k">return</span> <span class="k">await</span> <span class="n">message</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="s2">&quot;Эту команду могут использовать только администраторы.&quot;</span><span class="p">)</span>
    
    <span class="n">chat_id</span> <span class="o">=</span> <span class="k">await</span> <span class="n">get_group_id</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
    <span class="n">members</span> <span class="o">=</span> <span class="k">await</span> <span class="n">get_chat_members</span><span class="p">(</span><span class="n">chat_id</span><span class="p">)</span>
    
    <span class="n">mentions</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">member</span> <span class="ow">in</span> <span class="n">members</span><span class="p">:</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">member</span><span class="o">.</span><span class="n">user</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="o">.</span><span class="n">is_bot</span><span class="p">:</span>
            <span class="n">mention</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">user</span><span class="o">.</span><span class="n">first_name</span><span class="si">}</span><span class="s2">](tg://user?id=</span><span class="si">{</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">)&quot;</span>
            <span class="n">mentions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mention</span><span class="p">)</span>
    
    <span class="n">MAX_TAGS_PER_MESSAGE</span> <span class="o">=</span> <span class="mi">50</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">mentions</span><span class="p">),</span> <span class="n">MAX_TAGS_PER_MESSAGE</span><span class="p">):</span>
        <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">mentions</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="n">MAX_TAGS_PER_MESSAGE</span><span class="p">])</span>
        <span class="k">await</span> <span class="n">message</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">parse_mode</span><span class="o">=</span><span class="s1">&#39;Markdown&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="tag_admins">
<a class="viewcode-back" href="../bot.html#bot.tag_admins">[документация]</a>
<span class="nd">@dp</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="n">Command</span><span class="p">(</span><span class="s2">&quot;admins&quot;</span><span class="p">))</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">tag_admins</span><span class="p">(</span><span class="n">message</span><span class="p">:</span> <span class="n">Message</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Упоминает всех администраторов группы.</span>

<span class="sd">    Эта команда генерирует список упоминаний всех администраторов группы и отправляет их в сообщении.</span>

<span class="sd">    Аргументы:</span>
<span class="sd">    message (Message): Сообщение от пользователя с командой.</span>

<span class="sd">    Исключения:</span>
<span class="sd">    Отправляет сообщение об ошибке, если пользователь не является администратором.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="k">await</span> <span class="n">is_admin</span><span class="p">(</span><span class="n">message</span><span class="p">)</span> <span class="ow">and</span> <span class="n">message</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">SUPERUSERS</span><span class="p">:</span>
        <span class="k">return</span> <span class="k">await</span> <span class="n">message</span><span class="o">.</span><span class="n">reply</span><span class="p">(</span><span class="s2">&quot;Эту команду могут использовать только администраторы.&quot;</span><span class="p">)</span>
    
    <span class="n">chat_id</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">chat</span><span class="o">.</span><span class="n">id</span>
    <span class="n">admins</span> <span class="o">=</span> <span class="k">await</span> <span class="n">bot</span><span class="o">.</span><span class="n">get_chat_administrators</span><span class="p">(</span><span class="n">chat_id</span><span class="p">)</span>  

    <span class="n">bot_user</span> <span class="o">=</span> <span class="k">await</span> <span class="n">bot</span><span class="o">.</span><span class="n">get_me</span><span class="p">()</span>  
    <span class="n">mentions</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">admin</span> <span class="ow">in</span> <span class="n">admins</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">admin</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">id</span> <span class="o">!=</span> <span class="n">bot_user</span><span class="o">.</span><span class="n">id</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">admin</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_bot</span><span class="p">:</span> 
            <span class="n">mention</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&lt;a href=&#39;tg://user?id=</span><span class="si">{</span><span class="n">admin</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&#39;&gt;</span><span class="si">{</span><span class="n">admin</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">first_name</span><span class="si">}</span><span class="s2">&lt;/a&gt;&quot;</span>
            <span class="n">mentions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mention</span><span class="p">)</span>

    <span class="n">MAX_TAGS_PER_MESSAGE</span> <span class="o">=</span> <span class="mi">50</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">mentions</span><span class="p">),</span> <span class="n">MAX_TAGS_PER_MESSAGE</span><span class="p">):</span>
        <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">mentions</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="n">MAX_TAGS_PER_MESSAGE</span><span class="p">])</span>
        <span class="k">await</span> <span class="n">message</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">parse_mode</span><span class="o">=</span><span class="s1">&#39;HTML&#39;</span><span class="p">)</span>  </div>



<div class="viewcode-block" id="add_allowed_user">
<a class="viewcode-back" href="../bot.html#bot.add_allowed_user">[документация]</a>
<span class="nd">@dp</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="n">Command</span><span class="p">(</span><span class="s2">&quot;add_user&quot;</span><span class="p">))</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">add_allowed_user</span><span class="p">(</span><span class="n">message</span><span class="p">:</span> <span class="n">types</span><span class="o">.</span><span class="n">Message</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Добавляет нового пользователя в список разрешённых пользователей для выполнения определённых команд.</span>

<span class="sd">    Команда доступна только администраторам. После выполнения добавляет указанного пользователя в список разрешённых, если он ещё не добавлен.</span>

<span class="sd">    Аргументы:</span>
<span class="sd">    message (types.Message): Сообщение с командой, в котором указан ID пользователя.</span>

<span class="sd">    Исключения:</span>
<span class="sd">    Отправляет сообщение об ошибке, если формат команды неверен или если пользователь уже добавлен.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">message</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">SUPERUSERS</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">message</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;У вас нет прав для использования этой команды.&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">new_user_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">])</span> 
    <span class="k">except</span> <span class="p">(</span><span class="ne">IndexError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
        <span class="k">await</span> <span class="n">message</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;Неверный формат команды. Используйте: /add_user USER_ID&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">if</span> <span class="n">new_user_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ALLOWED_USERS</span><span class="p">:</span>
        <span class="n">ALLOWED_USERS</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_user_id</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">message</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Пользователь с ID </span><span class="si">{</span><span class="n">new_user_id</span><span class="si">}</span><span class="s2"> добавлен в список разрешённых.&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">message</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Пользователь с ID </span><span class="si">{</span><span class="n">new_user_id</span><span class="si">}</span><span class="s2"> уже в списке разрешённых.&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="get_bot_chats">
<a class="viewcode-back" href="../bot.html#bot.get_bot_chats">[документация]</a>
<span class="k">async</span> <span class="k">def</span> <span class="nf">get_bot_chats</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Возвращает список всех групп и супергрупп, в которых состоит бот.</span>

<span class="sd">    Функция извлекает все чаты, с которыми взаимодействует бот, фильтруя только группы и супергруппы.</span>

<span class="sd">    Возвращает:</span>
<span class="sd">    List: Список объектов чатов.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">chats</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">async</span> <span class="k">for</span> <span class="n">dialog</span> <span class="ow">in</span> <span class="n">pyrogram_client</span><span class="o">.</span><span class="n">get_dialogs</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">dialog</span><span class="o">.</span><span class="n">chat</span><span class="o">.</span><span class="n">type</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;group&quot;</span><span class="p">,</span> <span class="s2">&quot;supergroup&quot;</span><span class="p">]:</span>
            <span class="n">chats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dialog</span><span class="o">.</span><span class="n">chat</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">chats</span></div>



<div class="viewcode-block" id="add_group">
<a class="viewcode-back" href="../bot.html#bot.add_group">[документация]</a>
<span class="nd">@dp</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="n">Command</span><span class="p">(</span><span class="s2">&quot;add_group&quot;</span><span class="p">))</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">add_group</span><span class="p">(</span><span class="n">message</span><span class="p">:</span> <span class="n">types</span><span class="o">.</span><span class="n">Message</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Добавляет группу в список разрешённых для рассылки сообщений.</span>

<span class="sd">    Команда доступна только администраторам. После выполнения команда добавляет указанную группу в список, если она ещё не добавлена.</span>

<span class="sd">    Аргументы:</span>
<span class="sd">    message (types.Message): Сообщение с командой, в котором указан ID группы.</span>

<span class="sd">    Исключения:</span>
<span class="sd">    Отправляет сообщение об ошибке, если формат команды неверен или если группа уже добавлена.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">message</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">SUPERUSERS</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">message</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;У вас нет прав для использования этой команды.&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">chat_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">])</span>  
        <span class="n">chat</span> <span class="o">=</span> <span class="k">await</span> <span class="n">bot</span><span class="o">.</span><span class="n">get_chat</span><span class="p">(</span><span class="n">chat_id</span><span class="p">)</span> 
        <span class="k">if</span> <span class="n">chat_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">GROUPS</span><span class="p">:</span>
            <span class="n">GROUPS</span><span class="p">[</span><span class="n">chat_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">chat</span><span class="o">.</span><span class="n">title</span>
            <span class="k">await</span> <span class="n">message</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Группа &#39;</span><span class="si">{</span><span class="n">chat</span><span class="o">.</span><span class="n">title</span><span class="si">}</span><span class="s2">&#39; добавлена.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">message</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Группа &#39;</span><span class="si">{</span><span class="n">chat</span><span class="o">.</span><span class="n">title</span><span class="si">}</span><span class="s2">&#39; уже добавлена.&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">IndexError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
        <span class="k">await</span> <span class="n">message</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;Неверный формат команды. Используйте: /add_group CHAT_ID&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="start_broadcast">
<a class="viewcode-back" href="../bot.html#bot.start_broadcast">[документация]</a>
<span class="nd">@dp</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="n">Command</span><span class="p">(</span><span class="s2">&quot;broadcast&quot;</span><span class="p">))</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">start_broadcast</span><span class="p">(</span><span class="n">message</span><span class="p">:</span> <span class="n">types</span><span class="o">.</span><span class="n">Message</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Запускает процесс выбора группы для рассылки сообщения.</span>

<span class="sd">    Команда доступна только разрешённым пользователям и администраторам. Функция выводит список доступных групп для рассылки с использованием инлайн-кнопок.</span>

<span class="sd">    Аргументы:</span>
<span class="sd">    message (types.Message): Сообщение от пользователя с командой.</span>

<span class="sd">    Исключения:</span>
<span class="sd">    Отправляет сообщение, если список групп пуст или если у пользователя нет прав для рассылки.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">message</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ALLOWED_USERS</span> <span class="ow">and</span> <span class="n">message</span><span class="o">.</span><span class="n">from_user</span><span class="o">.</span><span class="n">id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">SUPERUSERS</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">message</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;У вас нет прав для использования этой команды.&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">GROUPS</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">message</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;Список групп пуст.&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="n">keyboard</span> <span class="o">=</span> <span class="n">InlineKeyboardBuilder</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">group_id</span><span class="p">,</span> <span class="n">group_name</span> <span class="ow">in</span> <span class="n">GROUPS</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">keyboard</span><span class="o">.</span><span class="n">button</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">group_name</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;send_to_</span><span class="si">{</span><span class="n">group_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">keyboard</span> <span class="o">=</span> <span class="n">keyboard</span><span class="o">.</span><span class="n">as_markup</span><span class="p">()</span>

    <span class="k">await</span> <span class="n">message</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;Выберите группу для рассылки:&quot;</span><span class="p">,</span> <span class="n">reply_markup</span><span class="o">=</span><span class="n">keyboard</span><span class="p">)</span></div>


<div class="viewcode-block" id="process_broadcast">
<a class="viewcode-back" href="../bot.html#bot.process_broadcast">[документация]</a>
<span class="nd">@dp</span><span class="o">.</span><span class="n">callback_query</span><span class="p">(</span><span class="k">lambda</span> <span class="n">call</span><span class="p">:</span> <span class="n">call</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;send_to_&quot;</span><span class="p">))</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">process_broadcast</span><span class="p">(</span><span class="n">call</span><span class="p">:</span> <span class="n">types</span><span class="o">.</span><span class="n">CallbackQuery</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">FSMContext</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Обрабатывает выбор группы для рассылки сообщения.</span>

<span class="sd">    Функция сохраняет ID выбранной группы и переходит в состояние ожидания сообщения для рассылки.</span>

<span class="sd">    Аргументы:</span>
<span class="sd">    call (types.CallbackQuery): Объект CallbackQuery с информацией о выборе группы.</span>
<span class="sd">    state (FSMContext): Контекст состояния FSM для сохранения данных.</span>

<span class="sd">    Исключения:</span>
<span class="sd">    None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">group_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">call</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">2</span><span class="p">])</span>

    <span class="k">await</span> <span class="n">call</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;Теперь отправьте сообщение для рассылки (текст, фото или видео).&quot;</span><span class="p">)</span>

    <span class="k">await</span> <span class="n">state</span><span class="o">.</span><span class="n">update_data</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="n">group_id</span><span class="p">)</span>

    <span class="k">await</span> <span class="n">state</span><span class="o">.</span><span class="n">set_state</span><span class="p">(</span><span class="n">BroadcastState</span><span class="o">.</span><span class="n">waiting_for_message</span><span class="p">)</span></div>


<div class="viewcode-block" id="handle_broadcast_message">
<a class="viewcode-back" href="../bot.html#bot.handle_broadcast_message">[документация]</a>
<span class="nd">@dp</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="n">BroadcastState</span><span class="o">.</span><span class="n">waiting_for_message</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">handle_broadcast_message</span><span class="p">(</span><span class="n">message</span><span class="p">:</span> <span class="n">types</span><span class="o">.</span><span class="n">Message</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">FSMContext</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Обрабатывает сообщение для рассылки.</span>

<span class="sd">    После выбора группы пользователь отправляет сообщение, которое бот рассылает указанной группе. Поддерживаются текст, фото и видео.</span>

<span class="sd">    Аргументы:</span>
<span class="sd">    message (types.Message): Сообщение от пользователя с контентом для рассылки.</span>
<span class="sd">    state (FSMContext): Контекст состояния FSM для извлечения данных о выбранной группе.</span>

<span class="sd">    Исключения:</span>
<span class="sd">    Отправляет сообщение об ошибке, если тип сообщения не поддерживается для рассылки.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="k">await</span> <span class="n">state</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>
    <span class="n">group_id</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;group_id&quot;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">message</span><span class="o">.</span><span class="n">text</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">bot</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span><span class="n">chat_id</span><span class="o">=</span><span class="n">group_id</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="n">message</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">message</span><span class="o">.</span><span class="n">photo</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">bot</span><span class="o">.</span><span class="n">send_photo</span><span class="p">(</span><span class="n">chat_id</span><span class="o">=</span><span class="n">group_id</span><span class="p">,</span> <span class="n">photo</span><span class="o">=</span><span class="n">message</span><span class="o">.</span><span class="n">photo</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">file_id</span><span class="p">,</span> <span class="n">caption</span><span class="o">=</span><span class="n">message</span><span class="o">.</span><span class="n">caption</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">message</span><span class="o">.</span><span class="n">video</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">bot</span><span class="o">.</span><span class="n">send_video</span><span class="p">(</span><span class="n">chat_id</span><span class="o">=</span><span class="n">group_id</span><span class="p">,</span> <span class="n">video</span><span class="o">=</span><span class="n">message</span><span class="o">.</span><span class="n">video</span><span class="o">.</span><span class="n">file_id</span><span class="p">,</span> <span class="n">caption</span><span class="o">=</span><span class="n">message</span><span class="o">.</span><span class="n">caption</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">message</span><span class="o">.</span><span class="n">answer</span><span class="p">(</span><span class="s2">&quot;Этот тип сообщения не поддерживается для рассылки.&quot;</span><span class="p">)</span>
   
    <span class="k">await</span> <span class="n">state</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span></div>


<div class="viewcode-block" id="main">
<a class="viewcode-back" href="../bot.html#bot.main">[документация]</a>
<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Основная функция запуска бота.</span>

<span class="sd">    В этой функции происходит инициализация бота, запуск опроса (polling) и запуск планировщика для ежедневной проверки дней рождения.</span>

<span class="sd">    Исключения:</span>
<span class="sd">    None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">await</span> <span class="n">on_startup</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span>
    <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">check_birthdays_daily</span><span class="p">())</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">dp</span><span class="o">.</span><span class="n">start_polling</span><span class="p">(</span><span class="n">bot</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">bot</span><span class="p">(</span><span class="n">DeleteWebhook</span><span class="p">(</span><span class="n">drop_pending_updates</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">on_shutdown</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">())</span>
</pre></div>
</main>
                        
                    </div>
                    
                </div>
            </div>
        </div>
    </div>
    <footer class="container-fluid bg-primary text-light">
        <div class="container">
            <div class="row">
        <div class="col p-4">
            
                <nav aria-label="Footer">
                    <ul class="nav justify-content-center mb-2">
                        
                            
                            
                            <li class="nav-item"><a class="nav-link text-light"  href="https://wagtail.org/features/">Features</a></li>
                        
                            
                            
                            <li class="nav-item"><a class="nav-link text-light"  href="https://wagtail.org/about-wagtail/"> About Wagtail</a></li>
                        
                            
                            
                            <li class="nav-item"><a class="nav-link text-light"  href="https://wagtail.org/services/"> Services</a></li>
                        
                            
                            
                            <li class="nav-item"><a class="nav-link text-light"  href="https://wagtail.org/blog/"> Blog</a></li>
                        
                            
                            
                            <li class="nav-item"><a class="nav-link text-light"  href="https://wagtail.org/packages/"> Packages</a></li>
                        
                            
                            
                            <li class="nav-item"><a class="nav-link text-light"  href="https://wagtail.org/developers/"> Developers</a></li>
                        
                    </ul>
                </nav>
            
            <div class="text-center">
                <p style="display: none">
                    <a class="text-light" href="https://github.com/wagtail/sphinx_wagtail_theme" rel="nofollow" target="_blank">
                        Wagtail Sphinx Theme 6.3.0
                    </a>
                </p>
            </div>
            <div class="text-center">
                    &copy; Copyright 2024, Атаев Георгий, Чибиров Руслан
            </div>
        </div>
    </div>
        </div>
    </footer>
        <script src="../_static/documentation_options.js?v=372fde1a"></script>
        <script src="../_static/doctools.js?v=9bcbadda"></script>
        <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
        <script src="../_static/translations.js?v=5b699b7f"></script>
        <script type="text/javascript" src="../_static/dist/theme.js"></script>
        <script type="text/javascript" src="../_static/dist/vendor.js"></script>
        <script type="text/javascript" src="../_static/searchtools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
        <script type="text/javascript">
            document.addEventListener('DOMContentLoaded', function() { Search.loadIndex("../searchindex.js"); });
        </script>
        <script type="text/javascript" id="searchindexloader"></script>
    </body>
</html>